<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>IoT Azure Hub Commander</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #05070a; --bg-card: #0f1218; --accent: #10b981; 
            --text-main: #f3f4f6; --text-dim: #9ca3af; --border: #1f2937;
            --json-key: #f472b6; --json-val: #34d399; --json-num: #fbbf24; 
        }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; }
        .navbar { background: rgba(5, 7, 10, 0.9); backdrop-filter: blur(12px); border-bottom: 2px solid var(--accent); padding: 1rem 0; margin-bottom: 20px; }
        .navbar-brand { font-weight: 800; color: var(--accent) !important; text-transform: uppercase; }

        /* --- COMMANDER PANEL --- */
        .send-panel {
            background: #111827; border: 1px solid var(--accent);
            border-radius: 12px; padding: 20px; margin-bottom: 40px;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.1);
        }
        .form-label { color: var(--accent); font-weight: 700; font-size: 0.8rem; text-transform: uppercase; }
        .form-control { 
            background: #000; border: 1px solid var(--border); color: #fff; 
            font-family: 'Fira Code', monospace; font-size: 0.9rem;
        }
        .form-control:focus { background: #050505; border-color: var(--accent); color: #fff; box-shadow: none; }
        .btn-send { 
            background: var(--accent); color: #000; font-weight: 800; border: none; 
            border-radius: 8px; padding: 10px 25px; transition: all 0.2s; height: 100%;
        }
        .btn-send:hover { background: #059669; transform: translateY(-2px); }

        /* --- TOPIC SECTIONS --- */
        .topic-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .topic-header { padding: 15px 20px; background: rgba(255, 255, 255, 0.03); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .topic-title { font-family: 'Fira Code', monospace; color: var(--accent); font-weight: 600; }
        .arrow { transition: transform 0.3s ease; display: inline-block; margin-right: 10px; color: var(--accent); }
        .table-scroll-area { max-height: 450px; overflow-y: auto; background: #090b10; border-top: 1px solid var(--border); }
        
        .collapsed .table-scroll-area { display: none; }
        .collapsed .arrow { transform: rotate(-90deg); }
        
        .time-col { color: var(--text-dim); font-size: 0.85rem; width: 120px; border-right: 1px solid var(--border); text-align: center; vertical-align: middle; }
        .payload-container { font-family: 'Fira Code', monospace; font-size: 0.85rem; padding: 12px; background: #000; border-radius: 6px; white-space: pre-wrap; margin: 0; }
        
        .json-string { color: var(--json-val); }
        .json-key { color: var(--json-key); }
        .json-num { color: var(--json-num); }
        .update-flash { animation: flash 0.5s ease-out; }
        @keyframes flash { 0% { background: rgba(16, 185, 129, 0.15); } 100% { background: transparent; } }
    </style>
</head>
<body>

<nav class="navbar sticky-top">
    <div class="container">
        <span class="navbar-brand">⚡ IoT Hub Commander</span>
        <div id="status" class="small text-success fw-bold">● LIVE CONNECTION</div>
    </div>
</nav>

<div class="container">
    <div class="send-panel">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Destination Topic</label>
                <input type="text" id="sendTopic" class="form-control" placeholder="np. devices/sensor_01">
            </div>
            <div class="col-md-6">
                <label class="form-label">Message</label>
                <textarea id="sendPayload" class="form-control" rows="1" placeholder='{"command": "reboot"}'></textarea>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn-send w-100" onclick="sendCommand()">SEND</button>
            </div>
        </div>
        <div id="sendResult" class="mt-2 small" style="display: none;"></div>
    </div>

    <div id="mainContainer">
        {% if messages %}
            {% set grouped = {} %}
            {% for msg in messages %}
                {% if msg.topic not in grouped %}
                    {% set _ = grouped.update({msg.topic: []}) %}
                {% endif %}
                {% set _ = grouped[msg.topic].append(msg) %}
            {% endfor %}

            {% for topic, msgs in grouped.items() %}
                <div class="topic-section" id="sec-{{ topic.replace('/', '-') }}">
                    <div class="topic-header" onclick="toggleSection('sec-{{ topic.replace('/', '-') }}')">
                        <div><span class="arrow">▼</span><span class="topic-title"># {{ topic }}</span></div>
                        <span class="badge bg-dark border border-secondary msg-count">{{ msgs|length }} msg</span>
                    </div>
                    <div class="table-scroll-area">
                        <table class="table table-borderless m-0">
                            <thead><tr><th class="time-col">Time</th><th>Payload</th></tr></thead>
                            <tbody>
                                {% for m in msgs %}
                                <tr>
                                    <td class="time-col">{{ m.created_at.strftime('%H:%M:%S') }}</td>
                                    <td><pre class="payload-container">{{ m.payload }}</pre></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    </div>
</div>

<script>
    const mainContainer = document.getElementById('mainContainer');
    const activeTopics = new Set();
    
    // Inicjalizacja Setu z tego co przyszło z Jinja2
    document.querySelectorAll('.topic-section').forEach(section => {
        const topic = section.querySelector('.topic-title').innerText.replace('# ', '');
        activeTopics.add(topic);
    });

    const socket = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`);

    function toggleSection(id) {
        document.getElementById(id).classList.toggle('collapsed');
    }

    // --- ANALYZER SYNTAX ---
    function syntaxHighlight(json) {
        if (typeof json !== 'string') json = JSON.stringify(json, null, 2);
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
            let cls = 'json-num';
            if (/^"/.test(match)) {
                if (/:$/.test(match)) cls = 'json-key';
                else cls = 'json-string';
            }
            return '<span class="' + cls + '">' + match + '</span>';
        });
    }

    // --- WYSYŁANIE DO SERWERA ---
    async function sendMessage() {
        const topic = document.getElementById('sendTopic').value;
        const payload = document.getElementById('sendPayload').value;
        const resultDiv = document.getElementById('sendResult');

        if (!topic || !payload) return;

        try {
            JSON.parse(payload);
            const response = await fetch('/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ topic, payload })
            });
            if (response.ok) {
                resultDiv.style.display = 'block';
                resultDiv.className = 'mt-2 small text-success';
                resultDiv.innerText = "✓ Wysłano C2D do urządzenia";
                setTimeout(() => resultDiv.style.display = 'none', 3000);
            }
        } catch (e) { alert("Payload musi być poprawnym JSONem!"); }
    }


    async function sendCommand() {
    const topic = document.getElementById('sendTopic').value;
    // Pobieramy tekst (czy to JSON, czy zwykły tekst - nie ma znaczenia)
    const payload = document.getElementById('sendPayload').value;
    const resultDiv = document.getElementById('sendResult');

    // Walidacja czy pola nie są puste
    if (!topic || !payload) {
        alert("Podaj temat i treść wiadomości!");
        return;
    }

    try {
        // USUNIĘTO: JSON.parse(payload) - teraz pozwalamy na zwykły tekst!

        const response = await fetch('/send', { // Upewnij się, że ten adres pasuje do Twojego backendu (np. /api/send)
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // Wysyłamy obiekt JSON, gdzie 'payload' jest po prostu napisem (stringiem)
            body: JSON.stringify({ 
                topic: topic, 
                // Ważne: Jeśli w Pythonie (FastAPI/Flask) używasz modelu z polem 'data', 
                // to zmień poniżej 'payload' na 'data'. 
                // Jeśli w Pythonie odbierasz 'payload', zostaw tak jak jest.
                payload: payload 
            })
        });

        if (response.ok) {
            resultDiv.style.display = 'block';
            resultDiv.className = 'mt-2 small text-success';
            resultDiv.innerText = "✓ Wysłano wiadomość do urządzenia";
            setTimeout(() => resultDiv.style.display = 'none', 3000);
        } else {
            // Dodano obsługę błędów serwera (np. błąd 500)
            const errText = await response.text(); 
            throw new Error("Błąd serwera: " + errText);
        }
    } catch (e) { 
        // Alert teraz pokazuje prawdziwy błąd (np. brak sieci), a nie tylko info o JSON
        alert("Wystąpił błąd: " + e.message); 
        console.error(e);
    }
}

    // --- TWORZENIE SEKCJI ---
    function createSection(topic) {
        const safeId = `sec-${topic.replace(/\//g, '-')}`;
        const html = `
            <div class="topic-section" id="${safeId}">
                <div class="topic-header" onclick="toggleSection('${safeId}')">
                    <div><span class="arrow">▼</span><span class="topic-title"># ${topic}</span></div>
                    <span class="badge bg-dark border border-secondary msg-count">0 msg</span>
                </div>
                <div class="table-scroll-area">
                    <table class="table table-borderless m-0">
                        <thead><tr><th class="time-col">Time</th><th>Payload</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>`;
        mainContainer.insertAdjacentHTML('afterbegin', html);
        activeTopics.add(topic);
    }

    // --- WEBSOCKET UPDATE ---
    socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (!activeTopics.has(data.topic)) createSection(data.topic);

        const safeId = `sec-${data.topic.replace(/\//g, '-')}`;
        const tbody = document.querySelector(`#${safeId} tbody`);
        const countBadge = document.querySelector(`#${safeId} .msg-count`);

        let formatted;
        try { 
            const obj = typeof data.payload === 'string' ? JSON.parse(data.payload) : data.payload;
            formatted = syntaxHighlight(obj); 
        } catch (e) { formatted = data.payload; }

        const row = document.createElement('tr');
        row.className = 'update-flash';
        const displayTime = data.time.includes(' ') ? data.time.split(' ')[1] : data.time;

        row.innerHTML = `
            <td class="time-col">${displayTime}</td>
            <td><pre class="payload-container">${formatted}</pre></td>
        `;

        tbody.prepend(row);
        if (tbody.rows.length > 20) tbody.deleteRow(20);
        countBadge.innerText = `${tbody.rows.length} msg`;
    };

    socket.onclose = () => {
        document.getElementById('status').innerText = "● DISCONNECTED";
        document.getElementById('status').className = "small text-danger fw-bold";
    };
</script>
</body>
</html>